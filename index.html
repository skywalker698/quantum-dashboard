<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0f172a">
  <title>Quantum Sugar AI Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0"></script>
  <style>
    body { font-family: 'Prompt', sans-serif; background: #f8fafc; }
    .container { max-width: 1300px; margin: 40px auto 100px; }
    .card, .chart-container { background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 24px; margin-bottom: 24px; }
    .btn { margin-bottom: 20px; }
    footer { position: fixed; bottom: 0; width: 100%; background: #0f172a; color: #fff; text-align: center; padding: 10px; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg" style="background:#0f172a;">
  <div class="container">
    <a class="navbar-brand text-white">üè≠ Quantum Sugar AI</a>
  </div>
</nav>

<div class="container">
  <!-- Summary -->
  <div class="row text-center">
    <div class="col-md-3 card"><h6>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</h6><h3 id="totalRevenue">‚Äì</h3></div>
    <div class="col-md-3 card"><h6>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</h6><h3 id="totalProfit">‚Äì</h3></div>
    <div class="col-md-3 card"><h6>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏≠‡πâ‡∏≠‡∏¢‡∏£‡∏ß‡∏°</h6><h3 id="totalCane">‚Äì</h3></div>
    <div class="col-md-3 card"><h6>ROI ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h6><h3 id="avgROI">‚Äì</h3></div>
  </div>

  <button id="btnForecast" class="btn btn-primary">üéØ Predict Next Year</button>
  <span id="forecastNotice" class="text-muted"></span>

  <!-- Trend Chart -->
  <div class="chart-container">
    <h5 class="text-center mb-4">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á + ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</h5>
    <canvas id="trendChart" height="120"></canvas>
  </div>

  <!-- Data Table -->
  <div class="chart-container">
    <h5 class="text-center mb-4">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
    <table class="table table-striped">
      <thead class="table-dark">
        <tr><th>‡∏õ‡∏µ</th><th>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th><th>‡∏Å‡∏≥‡πÑ‡∏£</th><th>‡∏≠‡πâ‡∏≠‡∏¢ (‡∏ï‡∏±‡∏ô)</th><th>Yield</th><th>ROI (%)</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<footer>¬© Quantum Sugar AI Dashboard 2025</footer>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbzrVLLUSjKiq7CDpX6H1EwYzXmo_hRiqRKMiextzxUidywAY_kfNXeyHUl8nDJG6KIyzw/exec";
let trendChart;

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏£‡∏≤‡∏ü
async function fetchData() {
  const res = await fetch(apiURL);
  const data = await res.json();

  const years = data.map(d=>d.year);
  const revenueArr = data.map(d=>+d.revenue);
  const costArr = data.map(d=>+d.cost);
  const profits = revenueArr.map((r,i)=>r - costArr[i]);
  const caneArr = data.map(d=>+d.totalCane);
  const yieldArr = data.map(d=>+d.yield);
  const roiArr = data.map(d=>+d.roi);

  // Summary
  document.getElementById("totalRevenue").innerText = revenueArr.reduce((a,b)=>a+b,0).toLocaleString()+" ‡∏ø";
  document.getElementById("totalProfit").innerText = profits.reduce((a,b)=>a+b,0).toLocaleString()+" ‡∏ø";
  document.getElementById("totalCane").innerText = caneArr.reduce((a,b)=>a+b,0).toLocaleString()+" ‡∏ï‡∏±‡∏ô";
  document.getElementById("avgROI").innerText = (roiArr.reduce((a,b)=>a+b,0)/roiArr.length).toFixed(2)+" %";

  // Table
  const body = document.getElementById("tableBody");
  body.innerHTML = "";
  data.forEach((d,i)=>{
    body.innerHTML += `<tr>
      <td>${d.year}</td>
      <td>${revenueArr[i].toLocaleString()}</td>
      <td>${costArr[i].toLocaleString()}</td>
      <td>${profits[i].toLocaleString()}</td>
      <td>${caneArr[i].toLocaleString()}</td>
      <td>${yieldArr[i]}</td>
      <td>${roiArr[i].toFixed(2)}</td>
    </tr>`;
  });

  // Trend Chart
  renderTrend(years, profits, yieldArr, caneArr, roiArr);

  // Setup Forecast
  setupForecast(profits, years);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏≤‡∏ü
function renderTrend(years, profits, yields, canes, rois, extendYear, extendProfit) {
  const ctx = document.getElementById("trendChart").getContext("2d");
  if (trendChart) trendChart.destroy();

  let xYears = [...years];
  let xProf = [...profits];

  if (extendYear) {
    xYears.push(extendYear);
    xProf.push(extendProfit);
  }

  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: xYears,
      datasets: [
        { label: '‡∏Å‡∏≥‡πÑ‡∏£', data: xProf, borderColor:'#10b981', tension:0.3 },
        { label: 'Yield', data: yields, borderColor:'#3b82f6', tension:0.3 },
        { label: '‡∏≠‡πâ‡∏≠‡∏¢', data: canes, borderColor:'#f59e0b', tension:0.3 },
        { label: 'ROI', data: rois, borderColor:'#ef4444', tension:0.3 }
      ]
    },
    options: { responsive: true }
  });
}

// ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡∏ù‡∏∂‡∏Å
function setupForecast(profits, years) {
  document.getElementById("btnForecast").onclick = async () => {
    document.getElementById("forecastNotice").innerText = "üß† ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
    const seq = 3;
    const X =[], Y=[];
    for(let i=0;i<profits.length-seq;i++){
      X.push(profits.slice(i,i+seq)); Y.push(profits[i+seq]);
    }
    const xs = tf.tensor2d(X, [X.length, seq]);
    const ys = tf.tensor1d(Y);
    const model = tf.sequential();
    model.add(tf.layers.dense({units:50,inputShape:[seq]}));
    model.add(tf.layers.reshape({targetShape:[seq,1]}));
    model.add(tf.layers.lstm({units:20}));
    model.add(tf.layers.dense({units:1}));
    model.compile({optimizer:'adam',loss:'meanSquaredError'});
    await model.fit(xs,ys,{epochs:80,verbose:0});
    const pred = await model.predict(tf.tensor2d([profits.slice(-seq)], [1,seq])).array();
    const nextProfit = pred[0][0];
    const nextYear = years[years.length-1] + 1;
    renderTrend(years, profits, profits.map((_,i)=>profits[i]), profits.map(_=>null), profits.map(_=>null), nextYear, nextProfit);
    document.getElementById("forecastNotice").innerText = `‚úÖ ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≥‡πÑ‡∏£ ‡∏õ‡∏µ ${nextYear}: ${Math.round(nextProfit).toLocaleString()} ‡∏ø`;
  };
}

document.addEventListener("DOMContentLoaded", fetchData);
</script>

</body>
</html>
